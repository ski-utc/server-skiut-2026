stages:
  - test
  - build
  - integration

variables:
  PROJECT_IMAGE_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
  PROJECT_IMAGE_LATEST: "$CI_REGISTRY_IMAGE:latest"

run_tests:
  stage: test
  tags:
    - linux
  image: laravelsail/php83-composer:latest
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    DB_CONNECTION: sqlite
    DB_DATABASE: /builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/database/database.sqlite
  script:
    - apt-get update && apt-get install -y libjpeg-dev libpng-dev libwebp-dev libfreetype6-dev
    - docker-php-ext-configure gd --with-freetype --with-jpeg --with-webp
    - docker-php-ext-install gd
    - cp .env.ci .env
    - composer install --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs
    - php artisan key:generate
    - php artisan jwt:generate
    - touch database/database.sqlite
    - php artisan migrate --force
    - php artisan test || php artisan test || php artisan test

build_docker_image:
  stage: build
  tags:
    - docker
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
        --context "${CI_PROJECT_DIR}"
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
        --destination "$PROJECT_IMAGE_TAG"
        --destination "$PROJECT_IMAGE_LATEST"
  only:
    - main

integration_test:
  stage: integration
  allow_failure: true
  tags:
    - docker-skiut
  script:
    - apk update && apk add curl
    - docker login -u gitlab-ci-token -p "$CI_JOB_TOKEN" "$CI_REGISTRY"
    - docker stop app || true
    - docker rm app || true
    - docker run -d -p 8090:80 --name app "$CI_REGISTRY_IMAGE:latest"
    - docker exec app php artisan jwt:generate
    - sleep 10
    - curl --fail http://localhost:8090/skiutc || (docker logs app && exit 1)
    - docker stop app && docker rm app
  only:
    - main
