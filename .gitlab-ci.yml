stages:
  - test
  - build
  - integration

variables:
  PROJECT_IMAGE_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
  PROJECT_IMAGE_LATEST: "$CI_REGISTRY_IMAGE:latest"

php-cs-fixer:
  stage: test
  allow_failure: true
  tags:
    - linux
  image: laravelsail/php83-composer:latest
  script:
    - composer install --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs
    - vendor/bin/php-cs-fixer fix --dry-run --diff         # Pour reformater automatiquement son code, faire vendor/bin/php-cs-fixer fix
    - echo "-------------------- Formatage du code OK ---------------------"

phpstan:
  stage: test
  tags:
    - linux
  image: laravelsail/php83-composer:latest
  script:
    - composer install --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs
    - php -d memory_limit=512M vendor/bin/phpstan analyse app bootstrap config database public routes tests
    - echo "-------------------- Pas d'erreur de syntaxe ---------------------"

security-checker:
  stage: test
  allow_failure: true
  tags:
    - linux
  image: laravelsail/php83-composer:latest
  script:
    - composer install --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs
    - php vendor/bin/security-checker security:check
    - echo "-------------------- Pas de faille de sécurité dans les deps ---------------------"

composer-outdated:
  stage: test
  allow_failure: true
  tags:
    - linux
  image: laravelsail/php83-composer:latest
  script:
    - composer install --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs
    - composer outdated --direct
    - echo "-------------------- Pas de dépendance obsolète ---------------------"

run-tests:
  stage: test
  tags:
    - linux
  image: laravelsail/php83-composer:latest
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    DB_CONNECTION: sqlite
    DB_DATABASE: /builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/database/database.sqlite
  script:
    - apt-get update && apt-get install -y libjpeg-dev libpng-dev libwebp-dev libfreetype6-dev
    - docker-php-ext-configure gd --with-freetype --with-jpeg --with-webp
    - docker-php-ext-install gd
    - composer install --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs
    - cp .env.ci .env
    - php artisan key:generate
    - php artisan jwt:generate
    - touch database/database.sqlite
    - php artisan migrate --force
    - php artisan test || php artisan test || php artisan test
    - echo "-------------------- Test des endpoits OK ---------------------"

build_docker_image:
  stage: build
  tags:
    - docker
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
        --context "${CI_PROJECT_DIR}"
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
        --destination "$PROJECT_IMAGE_TAG"
        --destination "$PROJECT_IMAGE_LATEST"
  only:
    - main

integration_test:
  stage: integration
  tags:
    - docker-skiut
  script:
    - apk update && apk add curl
    - docker login -u gitlab-ci-token -p "$CI_JOB_TOKEN" "$CI_REGISTRY"
    - docker stop app || true
    - docker rm app || true
    - docker run -d -p 8090:80 --name app "$CI_REGISTRY_IMAGE:latest"
    - docker exec app php artisan jwt:generate
    - sleep 10
    - docker exec app curl --fail http://localhost:80/skiutc || (docker logs app && exit 1)
    - docker stop app && docker rm app
  only:
    - main
